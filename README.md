# Скачивание треков и альбомов с Яндекс.Музыки

Эта программа позволяет скачивать треки с Яндекс.Музыки по ссылке и сохранять их в текущую директорию. Также доступен Telegram-бот для удобного скачивания треков.

## Требования

Для работы программы необходимо установить следующие зависимости:

```
pip install -r requirements.txt
```

## Использование

### Консольное приложение

1. Запустите программу:

```
python yandexMusicDownloader.py
```

2. По умолчанию программа скачает трек по ссылке, указанной в коде. Если вы хотите скачать другой трек или альбом, введите соответствующую ссылку при запросе.

3. Программа автоматически определит тип ссылки:
   - Если это ссылка на трек, он будет скачан в текущую директорию
   - Если это ссылка на альбом, будет создана отдельная папка с названием альбома, и в неё будут скачаны все треки с нумерацией

### Telegram-бот

1. Настройте переменные окружения в файле `.env` (см. раздел "Настройка переменных окружения").

2. Запустите бота:

```
python bot.py
```

3. Откройте бота в Telegram и отправьте ему ссылку на трек или альбом Яндекс.Музыки.

4. Бот автоматически определит тип ссылки:
   - Если это ссылка на трек, он будет скачан и отправлен вам
   - Если это ссылка на альбом, бот скачает все треки и отправит вам их с небольшой задержкой между сообщениями

## Резервное копирование базы данных

- Команда `/backup_now` (доступна только администраторам) формирует два JSON-файла (`users` и `downloads`) и отправляет их администратору в личные сообщения.
- Команда `/restore_backup` запускает пошаговое восстановление: сначала бот просит JSON с пользователями, затем с загрузками. На каждом шаге можно нажать кнопку «Пропустить», чтобы оставить таблицу без изменений. Перед восстановлением текущая база автоматически выгружается и отправляется администратору.
- По умолчанию бот сам раз в неделю (каждый понедельник в 09:00 по Москве) отправляет полный бэкап администратору. Расписание и часовую зону можно изменить через переменные окружения `BACKUP_CRON` (формат crontab) и `BACKUP_TZ`.
- При необходимости автономного запуска вне бота используйте скрипт `scripts/weekly_backup.py` — его можно привязать к любому планировщику.

### Docker Compose

1. Убедитесь, что у вас установлен Docker и Docker Compose.
2. Настройте переменные окружения в файле `.env` (см. раздел "Настройка переменных окружения").
3. Соберите и запустите контейнеры:

```bash
docker-compose up -d --build
```

4. Чтобы остановить бота, используйте команду:

```bash
docker-compose down
```

## Настройка переменных окружения

Для работы программы необходимо настроить переменные окружения в файле `.env`. Создайте файл `.env` на основе шаблона `.env.example` и заполните его своими данными:

```
# Токен для Telegram бота (получите у @BotFather)
BOT_TOKEN=your_telegram_bot_token_here

# Токен для Яндекс.Музыки
YM_TOKEN=your_yandex_music_token_here

# ID администратора, которому бот отправляет бэкапы
ADMIN_ID=your_telegram_user_id

# Плановое расписание бэкапов (необязательно)
# BACKUP_CRON=0 9 * * MON
# BACKUP_TZ=Europe/Moscow
```

## Примечание

Без авторизации с токеном Яндекс.Музыки программа может скачивать только превью треков (первые 30 секунд). Для скачивания полных треков необходимо получить токен и добавить его в файл `.env`.

Подробнее о получении токена можно узнать здесь: https://yandex-music.readthedocs.io/en/main/token.html

## Поддерживаемые форматы ссылок

Программа поддерживает следующие форматы ссылок на треки Яндекс.Музыки:

- https://music.yandex.ru/album/123456/track/7890123
- https://music.yandex.ru/track/7890123

## Функциональность

- Извлечение ID трека или альбома из различных форматов ссылок
- Получение информации о треке (название, исполнители)
- Скачивание трека в формате MP3
- Скачивание всех треков из альбома
- Автоматическое именование файла в формате "Исполнитель - Название.mp3"
- Создание отдельной папки для альбома с нумерацией треков
